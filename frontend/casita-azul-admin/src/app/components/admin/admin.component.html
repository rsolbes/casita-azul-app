<main class="container">
  <header class="admin-header">
    <h1>üè° {{ title }}</h1>
    <div class="user-info">
      @if (currentUser) {
        <span>üë§ {{ currentUser.email }}</span>
        @if (isAdmin) {
          <a routerLink="/admin/users" class="btn-admin-link">üë• Gestionar Usuarios</a>
          <a routerLink="/admin/agents" class="btn-admin-link">üßë‚Äçüíº Gestionar Agentes</a>
        }
      }
      <button class="btn-logout" (click)="logout()">üö™ Cerrar Sesi√≥n</button>
    </div>
  </header>

  @if (isLoading) {
    <p>Cargando datos...</p>
  }

  @if (errorMessage) {
    <div class="error-message">
      <p>‚ùå {{ errorMessage }}</p>
      <button (click)="loadData()">Reintentar carga</button>
    </div>
  }

  @if (!isLoading && !errorMessage) {

    @if (properties.length > 0) {
      <h2>Propiedades</h2>
      <div class="table-container">
        <table>
           <thead>
             <tr>
               <th>Imagen</th>
               <th>Acciones</th>
               <th>ID</th>
               <th>T√≠tulo</th>
               <th>Tipo Negocio</th>
               <th>Tipo Propiedad</th>
               <th>Estado Publicaci√≥n</th>
               <th>Precio</th>
               <th>Agente Asignado</th>
               <th>Creado</th>
             </tr>
           </thead>
           <tbody>
             @for (prop of properties; track prop.id) {
               <tr>
                 <td class="image-cell">
                   @if (getPrincipalImage(prop)) {
                     <img [src]="getPrincipalImage(prop)" alt="Imagen de {{ prop.titulo }}" class="property-thumbnail">
                   } @else {
                     <div class="no-image">Sin imagen</div>
                   }
                 </td>
                 <td>
                   <button (click)="editProperty(prop)">‚úèÔ∏è Editar</button>
                   <button (click)="deleteProperty(prop.id!)">üóëÔ∏è Eliminar</button>
                 </td>
                 <td>{{ prop.id }}</td>
                 <td>{{ prop.titulo }}</td>
                 <td>{{ getCatalogoNombre('tipos_negocio', prop.tipo_negocio_id) }}</td>
                 <td>{{ getCatalogoNombre('tipos_propiedad', prop.tipo_propiedad_id) }}</td>
                 <td>{{ getCatalogoNombre('estados_publicacion', prop.estado_publicacion_id) }}</td>
                 <td>{{ prop.precio | currency:'USD':'symbol':'1.0-0' }}</td>
                 <td>{{ getCatalogoNombre('agentes', prop.agente_id) }}</td>
                 <td>{{ prop.created_at | date:'short' }}</td>
               </tr>
             }
           </tbody>
        </table>
      </div>
    } @else {
      <p>No se encontraron propiedades.</p>
    }

    @if (editingProperty) {
      <section class="form-section editing-section">
        <h3>Editando Propiedad ID: {{ editingProperty.id }}</h3>

        <form class="property-form" (ngSubmit)="saveChanges()">
          <div class="form-grid">

            <fieldset>
              <legend>Datos Principales</legend>
              <label>T√≠tulo: <input [(ngModel)]="editingProperty.titulo" name="edit_titulo" required /></label>
              <label>Descripci√≥n: <textarea [(ngModel)]="editingProperty.descripcion" name="edit_desc"></textarea></label>
              <label>Direcci√≥n: <input [(ngModel)]="editingProperty.direccion" name="edit_dir" /></label>
              <label>C√≥digo Postal: <input [(ngModel)]="editingProperty.codigo_postal" name="edit_cp" /></label>
            </fieldset>

            <fieldset class="images-section">
              <legend>üì∏ Im√°genes de la Propiedad</legend>

              @if (editingImages && editingImages.length > 0) {
                <div class="images-grid">
                  @for (img of editingImages; track img.id) {
                    <div class="image-item">
                      <img [src]="img.url" [alt]="img.nombre_archivo">
                      <div class="image-actions">
                        @if (img.es_principal) {
                          <span class="badge-principal">‚≠ê Principal</span>
                        } @else {
                          <button type="button" class="btn-small" (click)="setPrincipal(editingProperty.id!, img.id)">
                            Hacer Principal
                          </button>
                        }
                        <button type="button" class="btn-delete-img" (click)="deleteImage(editingProperty.id!, img.id)">
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <p class="no-images-message">No hay im√°genes para esta propiedad.</p>
              }

              <div class="upload-section">
                <label class="file-upload-label">
                  <input
                    type="file"
                    multiple
                    accept="image/*"
                    (change)="onFileSelected($event)"
                    name="edit_images"
                  />
                  Seleccionar nuevas im√°genes
                </label>

                @if (selectedFiles.length > 0) {
                  <div class="selected-files">
                    <p>Archivos seleccionados ({{ selectedFiles.length }}):</p>
                    <ul>
                      @for (file of selectedFiles; track $index) {
                        <li>
                          {{ file.name }}
                          <button type="button" class="btn-remove-file" (click)="removeSelectedFile($index)">‚ùå</button>
                        </li>
                      }
                    </ul>
                  </div>
                }
              </div>
            </fieldset>

            <fieldset>
              <legend>Valores</legend>
              <label>Precio (Venta): <input [(ngModel)]="editingProperty.precio" name="edit_precio" type="number" /></label>
              <label>Precio (Alquiler): <input [(ngModel)]="editingProperty.precio_alquiler" name="edit_precio_alq" type="number" /></label>
              <label>Valor Administraci√≥n: <input [(ngModel)]="editingProperty.valor_administracion" name="edit_admin" type="number" /></label>
              <label>Moneda:
                <select [(ngModel)]="editingProperty.moneda_id" name="edit_moneda">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['monedas']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Frecuencia Alquiler:
                <select [(ngModel)]="editingProperty.frecuencia_alquiler_id" name="edit_freq_alq">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['frecuencias_alquiler']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
            </fieldset>

            <fieldset>
              <legend>Dimensiones y Espacios</legend>
              <label>Habitaciones: <input [(ngModel)]="editingProperty.habitaciones" name="edit_hab" type="number" /></label>
              <label>Alcobas: <input [(ngModel)]="editingProperty.alcobas" name="edit_alc" type="number" /></label>
              <label>Ba√±os: <input [(ngModel)]="editingProperty.banos" name="edit_ban" type="number" /></label>
              <label>Medios Ba√±os: <input [(ngModel)]="editingProperty.banos_medios" name="edit_ban_m" type="number" /></label>
              <label>Estacionamientos: <input [(ngModel)]="editingProperty.estacionamientos" name="edit_est" type="number" /></label>
              <label>A√±o Construcci√≥n: <input [(ngModel)]="editingProperty.anio_construccion" name="edit_anio" type="number" /></label>
              <label>Piso: <input [(ngModel)]="editingProperty.piso" name="edit_piso" /></label>
              <label>M¬≤ Terreno: <input [(ngModel)]="editingProperty.m2_terreno" name="edit_m2t" type="number" /></label>
              <label>M¬≤ Construcci√≥n: <input [(ngModel)]="editingProperty.m2_construccion" name="edit_m2c" type="number" /></label>
              <label>M¬≤ Privada: <input [(ngModel)]="editingProperty.m2_privada" name="edit_m2p" type="number" /></label>
            </fieldset>

            <fieldset>
              <legend>Clasificaci√≥n</legend>
              <label>Tipo de Negocio:
                <select [(ngModel)]="editingProperty.tipo_negocio_id" name="edit_tipo_neg" required>
                  <option [ngValue]="null">-- Selecciona --</option>
                  @for (item of catalogos['tipos_negocio']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Tipo de Propiedad:
                <select [(ngModel)]="editingProperty.tipo_propiedad_id" name="edit_tipo_prop" required>
                  <option [ngValue]="null">-- Selecciona --</option>
                  @for (item of catalogos['tipos_propiedad']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Estado Publicaci√≥n:
                <select [(ngModel)]="editingProperty.estado_publicacion_id" name="edit_est_pub" required>
                  <option [ngValue]="null">-- Selecciona --</option>
                  @for (item of catalogos['estados_publicacion']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Estado F√≠sico:
                <select [(ngModel)]="editingProperty.estado_fisico_id" name="edit_est_fis">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['estados_fisicos']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
            </fieldset>

            <fieldset>
              <legend>Ubicaci√≥n (Cat√°logos)</legend>
              <label>Estado:
                <select [(ngModel)]="editingProperty.estado_id" name="edit_estado">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['estados']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Ciudad:
                <select [(ngModel)]="editingProperty.ciudad_id" name="edit_ciudad">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['ciudades']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Zona:
                <select [(ngModel)]="editingProperty.zona_id" name="edit_zona">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['zonas']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
            </fieldset>

            <fieldset>
              <legend>Ubicaci√≥n (Coords. y Varios)</legend>
                <label>Latitud: <input [(ngModel)]="editingProperty.lat" name="edit_lat" type="number" /></label>
                <label>Longitud: <input [(ngModel)]="editingProperty.lng" name="edit_lng" type="number" /></label>
                <label>Registro P√∫blico: <input [(ngModel)]="editingProperty.registro_publico" name="edit_reg_pub" /></label>
            </fieldset>

            <fieldset>
              <legend>Agentes y Validaci√≥n</legend>
              <label>Captado por (Agente):
                <select [(ngModel)]="editingProperty.captado_por_agente_id" name="edit_cap_ag" required>
                  <option [ngValue]="null">-- Selecciona --</option>
                  @for (item of catalogos['agentes']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Agente Asignado:
                <select [(ngModel)]="editingProperty.agente_id" name="edit_ag">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['agentes']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Agente Externo:
                <select [(ngModel)]="editingProperty.agente_externo_id" name="edit_ag_ext">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['agentes_externos']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Convenio URL: <input [(ngModel)]="editingProperty.convenio_url" name="edit_conv_url" /></label>
              <label>Convenio Validado:
                <input type="checkbox" [(ngModel)]="editingProperty.convenio_validado" name="edit_conv_val" />
              </label>
              <label>Validado por (Usuario):
                <select [(ngModel)]="editingProperty.validado_por_usuario_id" name="edit_val_usr">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['agentes']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
            </fieldset>

          </div>
          <div class="form-actions">
            <button type="submit" [disabled]="uploadingImages">
              {{ uploadingImages ? 'üì§ Subiendo im√°genes...' : 'üíæ Guardar Cambios' }}
            </button>
            <button type="button" (click)="cancelEdit()">‚ùå Cancelar</button>
          </div>
        </form>
      </section>
    }

    @if (!editingProperty) {
      <section class="form-section">
        <h3>Agregar nueva propiedad</h3>
        <form class="property-form" (ngSubmit)="addProperty()">
          <div class="form-grid">

            <fieldset>
              <legend>Datos Principales</legend>
              <label>T√≠tulo: <input [(ngModel)]="newProperty.titulo" name="new_titulo" required /></label>
              <label>Descripci√≥n: <textarea [(ngModel)]="newProperty.descripcion" name="new_desc"></textarea></label>
              <label>Direcci√≥n: <input [(ngModel)]="newProperty.direccion" name="new_dir" /></label>
              <label>C√≥digo Postal: <input [(ngModel)]="newProperty.codigo_postal" name="new_cp" /></label>
            </fieldset>

            <fieldset class="images-section">
              <legend>üì∏ Im√°genes de la Propiedad</legend>

              <div class="upload-section">
                <label class="file-upload-label">
                  <input
                    type="file"
                    multiple
                    accept="image/*"
                    (change)="onFileSelected($event)"
                    name="new_images"
                  />
                  Seleccionar im√°genes
                </label>

                @if (selectedFiles.length > 0) {
                  <div class="selected-files">
                    <p>Archivos seleccionados ({{ selectedFiles.length }}):</p>
                    <ul>
                      @for (file of selectedFiles; track $index) {
                        <li>
                          {{ file.name }}
                          <button type="button" class="btn-remove-file" (click)="removeSelectedFile($index)">‚ùå</button>
                        </li>
                      }
                    </ul>
                    <p class="info-text">La primera imagen ser√° la imagen principal</p>
                  </div>
                }
              </div>
            </fieldset>

            <fieldset>
              <legend>Valores</legend>
              <label>Precio (Venta): <input [(ngModel)]="newProperty.precio" name="new_precio" type="number" /></label>
              <label>Precio (Alquiler): <input [(ngModel)]="newProperty.precio_alquiler" name="new_precio_alq" type="number" /></label>
              <label>Valor Administraci√≥n: <input [(ngModel)]="newProperty.valor_administracion" name="new_admin" type="number" /></label>
              <label>Moneda:
                <select [(ngModel)]="newProperty.moneda_id" name="new_moneda">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['monedas']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Frecuencia Alquiler:
                <select [(ngModel)]="newProperty.frecuencia_alquiler_id" name="new_freq_alq">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['frecuencias_alquiler']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
            </fieldset>

            <fieldset>
              <legend>Dimensiones y Espacios</legend>
              <label>Habitaciones: <input [(ngModel)]="newProperty.habitaciones" name="new_hab" type="number" /></label>
              <label>Alcobas: <input [(ngModel)]="newProperty.alcobas" name="new_alc" type="number" /></label>
              <label>Ba√±os: <input [(ngModel)]="newProperty.banos" name="new_ban" type="number" /></label>
              <label>Medios Ba√±os: <input [(ngModel)]="newProperty.banos_medios" name="new_ban_m" type="number" /></label>
              <label>Estacionamientos: <input [(ngModel)]="newProperty.estacionamientos" name="new_est" type="number" /></label>
              <label>A√±o Construcci√≥n: <input [(ngModel)]="newProperty.anio_construccion" name="new_anio" type="number" /></label>
              <label>Piso: <input [(ngModel)]="newProperty.piso" name="new_piso" /></label>
              <label>M¬≤ Terreno: <input [(ngModel)]="newProperty.m2_terreno" name="new_m2t" type="number" /></label>
              <label>M¬≤ Construcci√≥n: <input [(ngModel)]="newProperty.m2_construccion" name="new_m2c" type="number" /></label>
              <label>M¬≤ Privada: <input [(ngModel)]="newProperty.m2_privada" name="new_m2p" type="number" /></label>
            </fieldset>

            <fieldset>
              <legend>Clasificaci√≥n</legend>
              <label>Tipo de Negocio:
                <select [(ngModel)]="newProperty.tipo_negocio_id" name="new_tipo_neg" required>
                  <option [ngValue]="null">-- Selecciona --</option>
                  @for (item of catalogos['tipos_negocio']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Tipo de Propiedad:
                <select [(ngModel)]="newProperty.tipo_propiedad_id" name="new_tipo_prop" required>
                  <option [ngValue]="null">-- Selecciona --</option>
                  @for (item of catalogos['tipos_propiedad']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Estado Publicaci√≥n:
                <select [(ngModel)]="newProperty.estado_publicacion_id" name="new_est_pub" required>
                  <option [ngValue]="null">-- Selecciona --</option>
                  @for (item of catalogos['estados_publicacion']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Estado F√≠sico:
                <select [(ngModel)]="newProperty.estado_fisico_id" name="new_est_fis">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['estados_fisicos']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
            </fieldset>

            <fieldset>
              <legend>Ubicaci√≥n (Cat√°logos)</legend>
              <label>Estado:
                <select [(ngModel)]="newProperty.estado_id" name="new_estado">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['estados']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Ciudad:
                <select [(ngModel)]="newProperty.ciudad_id" name="new_ciudad">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['ciudades']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Zona:
                <select [(ngModel)]="newProperty.zona_id" name="new_zona">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['zonas']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
            </fieldset>

            <fieldset>
              <legend>Ubicaci√≥n (Coords. y Varios)</legend>
                <label>Latitud: <input [(ngModel)]="newProperty.lat" name="new_lat" type="number" /></label>
                <label>Longitud: <input [(ngModel)]="newProperty.lng" name="new_lng" type="number" /></label>
                <label>Registro P√∫blico: <input [(ngModel)]="newProperty.registro_publico" name="new_reg_pub" /></label>
            </fieldset>

            <fieldset>
              <legend>Agentes y Validaci√≥n</legend>
              <label>Captado por (Agente):
                <select [(ngModel)]="newProperty.captado_por_agente_id" name="new_cap_ag" required>
                  <option [ngValue]="null">-- Selecciona --</option>
                  @for (item of catalogos['agentes']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Agente Asignado:
                <select [(ngModel)]="newProperty.agente_id" name="new_ag">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['agentes']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Agente Externo:
                <select [(ngModel)]="newProperty.agente_externo_id" name="new_ag_ext">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['agentes_externos']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
              <label>Convenio URL: <input [(ngModel)]="newProperty.convenio_url" name="new_conv_url" /></label>
              <label>Convenio Validado:
                <input type="checkbox" [(ngModel)]="newProperty.convenio_validado" name="new_conv_val" />
              </label>
              <label>Validado por (Usuario):
                <select [(ngModel)]="newProperty.validado_por_usuario_id" name="new_val_usr">
                  <option [ngValue]="null">-- Opcional --</option>
                  @for (item of catalogos['agentes']; track item.id) {
                    <option [value]="item.id">{{ item.nombre }}</option>
                  }
                </select>
              </label>
            </fieldset>

          </div>
          <div class="form-actions">
            <button type="submit" [disabled]="uploadingImages">
              {{ uploadingImages ? 'üì§ Subiendo im√°genes...' : '‚ûï Agregar propiedad' }}
            </button>
          </div>
        </form>
      </section>
    }

  } </main>