<main class="container">
  <header class="admin-header">
    <h1>🏡 {{ title }}</h1>
    <div class="user-info">
      @if (currentUser) {
        <span>👤 {{ currentUser.email }}</span>
        @if (isAdmin) {
          <a routerLink="/admin/users" class="btn-admin-link">👥 Gestionar Usuarios</a>
          <a routerLink="/admin/agents" class="btn-admin-link">🧑‍💼 Gestionar Agentes</a>
        }
      }
      <button class="btn-logout" (click)="logout()">🚪 Cerrar Sesión</button>
    </div>
  </header>

  @if (isLoading) {
    <p>Cargando datos...</p>
  }

  @if (errorMessage) {
    <div class="error-message">
      <p>❌ {{ errorMessage }}</p>
      <button (click)="loadData()">Reintentar carga</button>
    </div>
  }

  @if (!isLoading && !errorMessage) {

    @if (properties.length > 0) {
      <h2>Propiedades</h2>
      <div class="table-container">
        <table>
          <thead>
             <tr>
               <th>Imagen</th>
               <th>Acciones</th>
               <th>ID</th>
               <th>Título</th>
               <th>Tipo Negocio</th>
               <th>Tipo Propiedad</th>
               <th>Estado Publicación</th>
               <th>Precio</th>
               <th>Agente Asignado</th>
               <th>Creado</th>
               </tr>
           </thead>
           <tbody>
             @for (prop of properties; track prop.id) {
               <tr>
                 <td class="image-cell">
                   @if (getPrincipalImage(prop)) {
                     <img [src]="getPrincipalImage(prop)" alt="Imagen de {{ prop.titulo }}" class="property-thumbnail">
                   } @else {
                     <div class="no-image">Sin imagen</div>
                   }
                 </td>
                 <td>
                   <button (click)="editProperty(prop)">✏️ Editar</button>
                   <button (click)="deleteProperty(prop.id!)">🗑️ Eliminar</button>
                 </td>
                 <td>{{ prop.id }}</td>
                 <td>{{ prop.titulo }}</td>
                 <td>{{ getCatalogoNombre('tipos_negocio', prop.tipo_negocio_id) }}</td>
                 <td>{{ getCatalogoNombre('tipos_propiedad', prop.tipo_propiedad_id) }}</td>
                 <td>{{ getCatalogoNombre('estados_publicacion', prop.estado_publicacion_id) }}</td>
                 <td>{{ prop.precio | currency:'USD':'symbol':'1.0-0' }}</td>
                 <td>{{ getCatalogoNombre('agentes', prop.agente_id) }}</td>
                 <td>{{ prop.created_at | date:'short' }}</td>
                 </tr>
             }
           </tbody>
        </table>
      </div>
    } @else {
      <p>No se encontraron propiedades.</p>
    }

    @if (editingProperty) {
      <section class="form-section editing-section">
         <h3>Editando Propiedad ID: {{ editingProperty.id }}</h3>
          <form class="property-form" (ngSubmit)="saveChanges()">
             <div class="form-actions">
                <button type="submit" [disabled]="uploadingImages">
                {{ uploadingImages ? '📤 Subiendo imágenes...' : '💾 Guardar Cambios' }}
                </button>
                <button type="button" (click)="cancelEdit()">❌ Cancelar</button>
             </div>
          </form>
      </section>
    }

    @if (!editingProperty) {
      <section class="form-section">
        <h3>Agregar nueva propiedad</h3>
          <form class="property-form" (ngSubmit)="addProperty()">
             <div class="form-actions">
                 <button type="submit" [disabled]="uploadingImages">
                 {{ uploadingImages ? '📤 Subiendo imágenes...' : '➕ Agregar propiedad' }}
                 </button>
             </div>
          </form>
      </section>
    }

  } </main>